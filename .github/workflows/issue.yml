name: Snyk Security Scan with SARIF Upload and Issue Creation

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  snyk_security_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up Snyk CLI
        uses: snyk/actions/setup@v1  # Updated to v1 (since v2 is not available)
        with:
          snyk-token: ${{ secrets.SNYK_TOKEN }}  # Use your Snyk token stored as a GitHub secret

      - name: Run Snyk Security Scan
        id: snyk_scan
        run: |
          snyk test --all-projects --json > snyk-report.json
          snyk monitor --all-projects

      - name: Upload SARIF Results to GitHub
        if: ${{ always() }}
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: snyk-report.json  # SARIF file output from Snyk

      - name: Check for Vulnerabilities and Create Issue
        if: ${{ steps.snyk_scan.outcome == 'failure' }}
        run: |
          echo "Vulnerabilities found, creating an issue"
          curl -X POST https://api.github.com/repos/${{ github.repository }}/issues \
            -H "Authorization: Bearer ${{ secrets.GH_PAT }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d @- <<EOF
            {
              "title": "Security vulnerabilities found in the code",
              "body": "Snyk security scan has found vulnerabilities in the code. Please check the Snyk scan report for details.",
              "labels": ["security", "bug"]
            }
            EOF
